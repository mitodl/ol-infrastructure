{
 "jobs": [
  {
   "build_log_retention": {
    "builds": 10.0
   },
   "name": "build-olive-mitx-edxapp-image",
   "plan": [
    {
     "in_parallel": [
      {
       "trigger": false,
       "get": "olive-mitx-theme"
      },
      {
       "trigger": false,
       "get": "olive-mitx-edx-platform"
      },
      {
       "trigger": false,
       "get": "ol-infrastructure-docker"
      }
     ]
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "alpine",
        "tag": "3.18.0"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [
        "-xc",
        "cp -r olive-mitx-theme collected_themes/mitx;\n                                    cp -rT olive-mitx-edx-platform edx_platform;\n                                    echo \"olive-mitx-$(cat edx_platform/.git/short_ref)\" > version/tag;"
       ],
       "path": "sh"
      },
      "inputs": [
       {
        "name": "olive-mitx-edx-platform"
       },
       {
        "name": "olive-mitx-theme"
       },
       {
        "name": "ol-infrastructure-docker"
       }
      ],
      "platform": "linux",
      "outputs": [
       {
        "name": "collected_themes"
       },
       {
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ]
     },
     "task": "collect-code"
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "concourse/oci-build-task"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [],
       "path": "build"
      },
      "inputs": [
       {
        "name": "ol-infrastructure-docker"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/collected_themes",
        "name": "collected_themes"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/edx_platform",
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ],
      "platform": "linux",
      "params": {
       "CONTEXT": "ol-infrastructure-docker/dockerfiles/openedx-edxapp",
       "TARGET": "final"
      },
      "outputs": [
       {
        "name": "image"
       }
      ]
     },
     "task": "build-container-image",
     "privileged": true
    },
    {
     "params": {
      "image": "image/image.tar",
      "additional_tags": "version/tag"
     },
     "put": "edxapp-olive-mitx-image"
    }
   ]
  },
  {
   "build_log_retention": {
    "builds": 10.0
   },
   "name": "build-olive-mitx-staging-edxapp-image",
   "plan": [
    {
     "in_parallel": [
      {
       "trigger": false,
       "get": "olive-mitx-staging-theme"
      },
      {
       "trigger": false,
       "get": "olive-mitx-staging-edx-platform"
      },
      {
       "trigger": false,
       "get": "ol-infrastructure-docker"
      }
     ]
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "alpine",
        "tag": "3.18.0"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [
        "-xc",
        "cp -r olive-mitx-staging-theme collected_themes/mitx-staging;\n                                    cp -rT olive-mitx-staging-edx-platform edx_platform;\n                                    echo \"olive-mitx-staging-$(cat edx_platform/.git/short_ref)\" > version/tag;"
       ],
       "path": "sh"
      },
      "inputs": [
       {
        "name": "olive-mitx-staging-edx-platform"
       },
       {
        "name": "olive-mitx-staging-theme"
       },
       {
        "name": "ol-infrastructure-docker"
       }
      ],
      "platform": "linux",
      "outputs": [
       {
        "name": "collected_themes"
       },
       {
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ]
     },
     "task": "collect-code"
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "concourse/oci-build-task"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [],
       "path": "build"
      },
      "inputs": [
       {
        "name": "ol-infrastructure-docker"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/collected_themes",
        "name": "collected_themes"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/edx_platform",
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ],
      "platform": "linux",
      "params": {
       "CONTEXT": "ol-infrastructure-docker/dockerfiles/openedx-edxapp",
       "TARGET": "final"
      },
      "outputs": [
       {
        "name": "image"
       }
      ]
     },
     "task": "build-container-image",
     "privileged": true
    },
    {
     "params": {
      "image": "image/image.tar",
      "additional_tags": "version/tag"
     },
     "put": "edxapp-olive-mitx-staging-image"
    }
   ]
  },
  {
   "build_log_retention": {
    "builds": 10.0
   },
   "name": "build-olive-xpro-edxapp-image",
   "plan": [
    {
     "in_parallel": [
      {
       "trigger": false,
       "get": "olive-xpro-theme"
      },
      {
       "trigger": false,
       "get": "olive-xpro-edx-platform"
      },
      {
       "trigger": false,
       "get": "ol-infrastructure-docker"
      }
     ]
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "alpine",
        "tag": "3.18.0"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [
        "-xc",
        "cp -r olive-xpro-theme collected_themes/xpro;\n                                    cp -rT olive-xpro-edx-platform edx_platform;\n                                    echo \"olive-xpro-$(cat edx_platform/.git/short_ref)\" > version/tag;"
       ],
       "path": "sh"
      },
      "inputs": [
       {
        "name": "olive-xpro-edx-platform"
       },
       {
        "name": "olive-xpro-theme"
       },
       {
        "name": "ol-infrastructure-docker"
       }
      ],
      "platform": "linux",
      "outputs": [
       {
        "name": "collected_themes"
       },
       {
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ]
     },
     "task": "collect-code"
    },
    {
     "config": {
      "image_resource": {
       "source": {
        "repository": "concourse/oci-build-task"
       },
       "type": "registry-image"
      },
      "run": {
       "args": [],
       "path": "build"
      },
      "inputs": [
       {
        "name": "ol-infrastructure-docker"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/collected_themes",
        "name": "collected_themes"
       },
       {
        "path": "ol-infrastructure-docker/dockerfiles/openedx-edxapp/edx_platform",
        "name": "edx_platform"
       },
       {
        "name": "version"
       }
      ],
      "platform": "linux",
      "params": {
       "CONTEXT": "ol-infrastructure-docker/dockerfiles/openedx-edxapp",
       "TARGET": "final"
      },
      "outputs": [
       {
        "name": "image"
       }
      ]
     },
     "task": "build-container-image",
     "privileged": true
    },
    {
     "params": {
      "image": "image/image.tar",
      "additional_tags": "version/tag"
     },
     "put": "edxapp-olive-xpro-image"
    }
   ]
  },
  {
   "name": "validate-packer-template-mitx",
   "plan": [
    {
     "passed": [
      "build-olive-mitx-edxapp-image"
     ],
     "trigger": false,
     "get": "edxapp-olive-mitx-image"
    },
    {
     "trigger": true,
     "get": "edxapp-custom-image-mitx"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "web"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/mitx.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      },
      {
       "params": {
        "template": "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "worker"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/mitx.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      }
     ]
    }
   ]
  },
  {
   "name": "build-packer-template-mitx",
   "plan": [
    {
     "passed": [
      "validate-packer-template-mitx"
     ],
     "trigger": false,
     "get": "edxapp-olive-mitx-image"
    },
    {
     "passed": [
      "validate-packer-template-mitx"
     ],
     "trigger": true,
     "get": "edxapp-custom-image-mitx"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "web"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-mitx/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/mitx.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      },
      {
       "params": {
        "template": "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "worker"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-mitx/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx/src/bilder/images/edxapp_v2/packer_vars/mitx.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      }
     ]
    }
   ]
  },
  {
   "name": "validate-packer-template-mitx-staging",
   "plan": [
    {
     "passed": [
      "build-olive-mitx-staging-edxapp-image"
     ],
     "trigger": false,
     "get": "edxapp-olive-mitx-staging-image"
    },
    {
     "trigger": true,
     "get": "edxapp-custom-image-mitx-staging"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "web"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/mitx-staging.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      },
      {
       "params": {
        "template": "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "worker"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/mitx-staging.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      }
     ]
    }
   ]
  },
  {
   "name": "build-packer-template-mitx-staging",
   "plan": [
    {
     "passed": [
      "validate-packer-template-mitx-staging"
     ],
     "trigger": false,
     "get": "edxapp-olive-mitx-staging-image"
    },
    {
     "passed": [
      "validate-packer-template-mitx-staging"
     ],
     "trigger": true,
     "get": "edxapp-custom-image-mitx-staging"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "web"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-mitx-staging/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/mitx-staging.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      },
      {
       "params": {
        "template": "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "worker"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-mitx-staging/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-mitx-staging/src/bilder/images/edxapp_v2/packer_vars/mitx-staging.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      }
     ]
    }
   ]
  },
  {
   "name": "validate-packer-template-xpro",
   "plan": [
    {
     "passed": [
      "build-olive-xpro-edxapp-image"
     ],
     "trigger": false,
     "get": "edxapp-olive-xpro-image"
    },
    {
     "trigger": true,
     "get": "edxapp-custom-image-xpro"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "web"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/xpro.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      },
      {
       "params": {
        "template": "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "validate",
        "vars": {
         "node_type": "worker"
        },
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/xpro.pkrvars.hcl"
        ]
       },
       "put": "packer-validate"
      }
     ]
    }
   ]
  },
  {
   "name": "build-packer-template-xpro",
   "plan": [
    {
     "passed": [
      "validate-packer-template-xpro"
     ],
     "trigger": false,
     "get": "edxapp-olive-xpro-image"
    },
    {
     "passed": [
      "validate-packer-template-xpro"
     ],
     "trigger": true,
     "get": "edxapp-custom-image-xpro"
    },
    {
     "in_parallel": [
      {
       "params": {
        "template": "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "web"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-xpro/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/xpro.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      },
      {
       "params": {
        "template": "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/custom_install.pkr.hcl",
        "objective": "build",
        "vars": {
         "node_type": "worker"
        },
        "env_vars": {
         "AWS_REGION": "us-east-1",
         "PYTHONPATH": "${PYTHONPATH}:edxapp-custom-image-xpro/src"
        },
        "env_vars_from_files": {},
        "only": [
         "amazon-ebs.edxapp"
        ],
        "var_files": [
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/olive.pkrvars.hcl",
         "edxapp-custom-image-xpro/src/bilder/images/edxapp_v2/packer_vars/xpro.pkrvars.hcl"
        ]
       },
       "put": "packer-build"
      }
     ]
    }
   ]
  }
 ],
 "resource_types": [
  {
   "source": {
    "repository": "mitodl/concourse-packer-resource",
    "tag": "latest"
   },
   "type": "registry-image",
   "name": "packer-validator"
  },
  {
   "source": {
    "repository": "mitodl/concourse-packer-resource-builder",
    "tag": "latest"
   },
   "type": "registry-image",
   "name": "packer-builder"
  }
 ],
 "resources": [
  {
   "name": "ol-infrastructure-docker",
   "source": {
    "uri": "https://github.com/mitodl/ol-infrastructure",
    "branch": "md/edxapp_docker_migration",
    "paths": [
     "dockerfiles/openedx-edxapp"
    ],
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "edxapp-olive-mitx-image",
   "source": {
    "repository": "mitodl/edxapp",
    "tag": "olive-mitx",
    "username": "((dockerhub.username))",
    "password": "((dockerhub.password))"
   },
   "type": "registry-image"
  },
  {
   "name": "edxapp-custom-image-mitx",
   "source": {
    "uri": "https://github.com/mitodl/ol-infrastructure",
    "branch": "md/edxapp_docker_migration",
    "paths": [
     "src/bridge/settings/openedx",
     "src/bilder/components",
     "src/bilder/images/edxapp/deploy.py",
     "src/bilder/images/edxapp/group_data",
     "src/bilder/images/edxapp/templates/vector",
     "src/bilder/images/edxapp/templates/edxapp/mitx",
     "src/bilder/images/edxapp/custom_install.pkr.hcl",
     "src/bilder/images/edxapp/packer_vars/mitx.pkrvars.hcl",
     "src/bilder/images/edxapp/packer_vars/olive.pkrvars.hcl"
    ],
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-mitx-theme",
   "source": {
    "uri": "https://github.com/mitodl/mitx-theme",
    "branch": "olive",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-mitx-edx-platform",
   "source": {
    "uri": "https://github.com/mitodl/edx-platform",
    "branch": "mitx/olive",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "edxapp-olive-mitx-staging-image",
   "source": {
    "repository": "mitodl/edxapp",
    "tag": "olive-mitx-staging",
    "username": "((dockerhub.username))",
    "password": "((dockerhub.password))"
   },
   "type": "registry-image"
  },
  {
   "name": "edxapp-custom-image-mitx-staging",
   "source": {
    "uri": "https://github.com/mitodl/ol-infrastructure",
    "branch": "md/edxapp_docker_migration",
    "paths": [
     "src/bridge/settings/openedx",
     "src/bilder/components",
     "src/bilder/images/edxapp/deploy.py",
     "src/bilder/images/edxapp/group_data",
     "src/bilder/images/edxapp/templates/vector",
     "src/bilder/images/edxapp/templates/edxapp/mitx-staging",
     "src/bilder/images/edxapp/custom_install.pkr.hcl",
     "src/bilder/images/edxapp/packer_vars/mitx-staging.pkrvars.hcl",
     "src/bilder/images/edxapp/packer_vars/olive.pkrvars.hcl"
    ],
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-mitx-staging-theme",
   "source": {
    "uri": "https://github.com/mitodl/mitx-theme",
    "branch": "olive",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-mitx-staging-edx-platform",
   "source": {
    "uri": "https://github.com/mitodl/edx-platform",
    "branch": "mitx/olive",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "edxapp-olive-xpro-image",
   "source": {
    "repository": "mitodl/edxapp",
    "tag": "olive-xpro",
    "username": "((dockerhub.username))",
    "password": "((dockerhub.password))"
   },
   "type": "registry-image"
  },
  {
   "name": "edxapp-custom-image-xpro",
   "source": {
    "uri": "https://github.com/mitodl/ol-infrastructure",
    "branch": "md/edxapp_docker_migration",
    "paths": [
     "src/bridge/settings/openedx",
     "src/bilder/components",
     "src/bilder/images/edxapp/deploy.py",
     "src/bilder/images/edxapp/group_data",
     "src/bilder/images/edxapp/templates/vector",
     "src/bilder/images/edxapp/templates/edxapp/xpro",
     "src/bilder/images/edxapp/custom_install.pkr.hcl",
     "src/bilder/images/edxapp/packer_vars/xpro.pkrvars.hcl",
     "src/bilder/images/edxapp/packer_vars/olive.pkrvars.hcl"
    ],
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-xpro-theme",
   "source": {
    "uri": "https://github.com/mitodl/mitxpro-theme",
    "branch": "olive",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "olive-xpro-edx-platform",
   "source": {
    "uri": "https://github.com/openedx/edx-platform",
    "branch": "open-release/olive.master",
    "paths": null,
    "private_key": null,
    "ignore_paths": null,
    "depth": null
   },
   "check_every": "60s",
   "icon": "git",
   "type": "git"
  },
  {
   "name": "packer-validate",
   "type": "packer-validator"
  },
  {
   "name": "packer-build",
   "type": "packer-builder"
  }
 ]
}
