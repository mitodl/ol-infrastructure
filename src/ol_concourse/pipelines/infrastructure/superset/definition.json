{
  "jobs": [
    {
      "name": "build-superset-image",
      "plan": [
        {
          "trigger": true,
          "get": "ol-inf-superset-docker-code"
        },
        {
          "config": {
            "image_resource": {
              "source": {
                "repository": "concourse/oci-build-task"
              },
              "type": "registry-image"
            },
            "caches": [
              {
                "path": "cache"
              }
            ],
            "run": {
              "args": [],
              "path": "build"
            },
            "inputs": [
              {
                "name": "ol-inf-superset-docker-code"
              }
            ],
            "platform": "linux",
            "params": {
              "CONTEXT": "ol-inf-superset-docker-code/ol_superset"
            },
            "outputs": [
              {
                "name": "image"
              }
            ]
          },
          "task": "build-container-image",
          "privileged": true
        },
        {
          "params": {
            "image": "image/image.tar"
          },
          "put": "supserset-image",
          "inputs": "all"
        }
      ]
    },
    {
      "name": "validate-packer-template",
      "plan": [
        {
          "passed": [
            "build-superset-image"
          ],
          "trigger": true,
          "get": "supserset-image"
        },
        {
          "trigger": true,
          "get": "ol-inf-superset-packer-code"
        },
        {
          "in_parallel": [
            {
              "params": {
                "template": "ol-inf-superset-packer-code/src/bilder/images/superset/superset.pkr.hcl",
                "objective": "validate",
                "vars": {
                  "node_type": "server"
                },
                "only": [
                  "amazon-ebs.superset"
                ]
              },
              "put": "packer-validate"
            }
          ]
        }
      ]
    },
    {
      "name": "build-packer-template",
      "plan": [
        {
          "passed": [
            "validate-packer-template"
          ],
          "trigger": true,
          "get": "supserset-image"
        },
        {
          "passed": [
            "validate-packer-template"
          ],
          "trigger": true,
          "get": "ol-inf-superset-packer-code"
        },
        {
          "in_parallel": [
            {
              "params": {
                "template": "ol-inf-superset-packer-code/src/bilder/images/superset/superset.pkr.hcl",
                "objective": "build",
                "vars": {
                  "node_type": "server"
                },
                "env_vars": {
                  "AWS_REGION": "us-east-1",
                  "PYTHONPATH": "${PYTHONPATH}:ol-inf-superset-packer-code/src"
                },
                "env_vars_from_files": {
                  "SUPERSET_IMAGE_SHA": "supserset-image/digest"
                },
                "only": [
                  "amazon-ebs.superset"
                ]
              },
              "put": "packer-build"
            }
          ]
        }
      ]
    },
    {
      "max_in_flight": 1.0,
      "name": "deploy-ol-infrastructure-superset-server-applications.superset.ci",
      "on_success": {
        "params": {
          "labels": [
            "product:infrastructure",
            "DevOps",
            "pipeline-workflow",
            "promotion-to-qa"
          ],
          "assignees": [
            "blarghmatey",
            "feoh",
            "shaidar",
            "Ardiea"
          ]
        },
        "put": "github-issues-applications.superset.ci-post"
      },
      "plan": [
        {
          "passed": [
            "build-packer-template"
          ],
          "trigger": true,
          "get": "packer-build"
        },
        {
          "trigger": true,
          "get": "ol-inf-superset-pulumi-code"
        },
        {
          "config": {
            "image_resource": {
              "source": {
                "repository": "amazon/aws-cli",
                "tag": "latest"
              },
              "type": "registry-image"
            },
            "run": {
              "path": "ol-inf-superset-pulumi-code/pipelines/infrastructure/scripts/generate_aws_config_from_instance_profile.sh"
            },
            "inputs": [
              {
                "name": "ol-inf-superset-pulumi-code"
              }
            ],
            "platform": "linux",
            "outputs": [
              {
                "name": "aws_creds"
              }
            ]
          },
          "task": "set-aws-creds"
        },
        {
          "params": {
            "env_os": {
              "AWS_DEFAULT_REGION": "us-east-1",
              "PYTHONPATH": "/usr/lib/:/tmp/build/put/ol-inf-superset-pulumi-code/src/"
            },
            "stack_name": "applications.superset.CI"
          },
          "get_params": {
            "skip_implicit_get": true
          },
          "put": "pulumi-ol-infrastructure-superset-server"
        }
      ]
    },
    {
      "max_in_flight": 1.0,
      "name": "deploy-ol-infrastructure-superset-server-applications.superset.qa",
      "on_success": {
        "params": {
          "labels": [
            "product:infrastructure",
            "DevOps",
            "pipeline-workflow",
            "promotion-to-production"
          ],
          "assignees": [
            "blarghmatey",
            "feoh",
            "shaidar",
            "Ardiea"
          ]
        },
        "put": "github-issues-applications.superset.qa-post"
      },
      "plan": [
        {
          "passed": [
            "deploy-ol-infrastructure-superset-server-applications.superset.ci"
          ],
          "trigger": false,
          "get": "packer-build"
        },
        {
          "trigger": true,
          "get": "github-issues-applications.superset.ci-trigger"
        },
        {
          "passed": [
            "deploy-ol-infrastructure-superset-server-applications.superset.ci"
          ],
          "trigger": false,
          "get": "ol-inf-superset-pulumi-code"
        },
        {
          "config": {
            "image_resource": {
              "source": {
                "repository": "amazon/aws-cli",
                "tag": "latest"
              },
              "type": "registry-image"
            },
            "run": {
              "path": "ol-inf-superset-pulumi-code/pipelines/infrastructure/scripts/generate_aws_config_from_instance_profile.sh"
            },
            "inputs": [
              {
                "name": "ol-inf-superset-pulumi-code"
              }
            ],
            "platform": "linux",
            "outputs": [
              {
                "name": "aws_creds"
              }
            ]
          },
          "task": "set-aws-creds"
        },
        {
          "params": {
            "env_os": {
              "AWS_DEFAULT_REGION": "us-east-1",
              "PYTHONPATH": "/usr/lib/:/tmp/build/put/ol-inf-superset-pulumi-code/src/"
            },
            "stack_name": "applications.superset.QA"
          },
          "get_params": {
            "skip_implicit_get": true
          },
          "put": "pulumi-ol-infrastructure-superset-server"
        }
      ]
    },
    {
      "max_in_flight": 1.0,
      "name": "deploy-ol-infrastructure-superset-server-applications.superset.production",
      "on_success": {
        "params": {
          "labels": [
            "product:infrastructure",
            "DevOps",
            "pipeline-workflow",
            "finalized-deployment"
          ],
          "assignees": [
            "blarghmatey",
            "feoh",
            "shaidar",
            "Ardiea"
          ]
        },
        "put": "github-issues-applications.superset.production-post"
      },
      "plan": [
        {
          "passed": [
            "deploy-ol-infrastructure-superset-server-applications.superset.qa"
          ],
          "trigger": false,
          "get": "packer-build"
        },
        {
          "trigger": true,
          "get": "github-issues-applications.superset.qa-trigger"
        },
        {
          "passed": [
            "deploy-ol-infrastructure-superset-server-applications.superset.qa"
          ],
          "trigger": false,
          "get": "ol-inf-superset-pulumi-code"
        },
        {
          "config": {
            "image_resource": {
              "source": {
                "repository": "amazon/aws-cli",
                "tag": "latest"
              },
              "type": "registry-image"
            },
            "run": {
              "path": "ol-inf-superset-pulumi-code/pipelines/infrastructure/scripts/generate_aws_config_from_instance_profile.sh"
            },
            "inputs": [
              {
                "name": "ol-inf-superset-pulumi-code"
              }
            ],
            "platform": "linux",
            "outputs": [
              {
                "name": "aws_creds"
              }
            ]
          },
          "task": "set-aws-creds"
        },
        {
          "params": {
            "env_os": {
              "AWS_DEFAULT_REGION": "us-east-1",
              "PYTHONPATH": "/usr/lib/:/tmp/build/put/ol-inf-superset-pulumi-code/src/"
            },
            "stack_name": "applications.superset.Production"
          },
          "get_params": {
            "skip_implicit_get": true
          },
          "put": "pulumi-ol-infrastructure-superset-server"
        }
      ]
    }
  ],
  "resource_types": [
    {
      "source": {
        "repository": "mitodl/concourse-packer-resource",
        "tag": "latest"
      },
      "type": "registry-image",
      "name": "packer-validator"
    },
    {
      "source": {
        "repository": "mitodl/concourse-packer-resource-builder",
        "tag": "latest"
      },
      "type": "registry-image",
      "name": "packer-builder"
    },
    {
      "source": {
        "repository": "mitodl/ol-concourse-github-issues",
        "tag": "latest"
      },
      "type": "registry-image",
      "name": "github-issues"
    },
    {
      "source": {
        "repository": "mitodl/concourse-pulumi-resource-provisioner",
        "tag": "latest"
      },
      "type": "registry-image",
      "name": "pulumi-provisioner"
    }
  ],
  "resources": [
    {
      "name": "ol-inf-superset-docker-code",
      "source": {
        "uri": "https://github.com/mitodl/ol-infrastructure",
        "branch": "main",
        "paths": [
          "src/ol_superset"
        ]
      },
      "check_every": "60s",
      "icon": "git",
      "type": "git"
    },
    {
      "name": "ol-inf-superset-packer-code",
      "source": {
        "uri": "https://github.com/mitodl/ol-infrastructure",
        "branch": "main",
        "paths": [
          "src/ol_superset"
        ]
      },
      "check_every": "60s",
      "icon": "git",
      "type": "git"
    },
    {
      "name": "ol-inf-superset-pulumi-code",
      "source": {
        "uri": "https://github.com/mitodl/ol-infrastructure",
        "branch": "main",
        "paths": [
          "src/ol_superset"
        ]
      },
      "check_every": "60s",
      "icon": "git",
      "type": "git"
    },
    {
      "name": "supserset-image",
      "source": {
        "repository": "mitodl/superset",
        "tag": "latest",
        "username": "((dockerhub.username))",
        "password": "((dockerhub.password))"
      },
      "type": "registry-image"
    },
    {
      "name": "packer-validate",
      "type": "packer-validator"
    },
    {
      "name": "packer-build",
      "type": "packer-builder"
    },
    {
      "name": "pulumi-ol-infrastructure-superset-server",
      "source": {
        "env_pulumi": {
          "AWS_SHARED_CREDENTIALS_FILE": "aws_creds/credentials"
        },
        "action": "update",
        "project_name": "ol-infrastructure-superset-server",
        "source_dir": "ol-inf-superset-pulumi-code/src/ol_infrastructure/applications/superset"
      },
      "icon": "cloud-braces",
      "type": "pulumi-provisioner"
    },
    {
      "name": "github-issues-applications.superset.ci-post",
      "source": {
        "access_token": "((github.issues_resource_access_token))",
        "issue_prefix": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.CI deployed.",
        "issue_state": "open",
        "issue_title_template": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.CI deployed.",
        "repository": "mitodl/concourse-workflow"
      },
      "expose_build_created_by": true,
      "check_every": "1h",
      "icon": "github",
      "type": "github-issues"
    },
    {
      "name": "github-issues-applications.superset.ci-trigger",
      "source": {
        "access_token": "((github.issues_resource_access_token))",
        "issue_prefix": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.CI deployed.",
        "issue_state": "closed",
        "issue_title_template": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.CI deployed.",
        "repository": "mitodl/concourse-workflow"
      },
      "expose_build_created_by": true,
      "check_every": "1h",
      "icon": "github",
      "type": "github-issues"
    },
    {
      "name": "github-issues-applications.superset.qa-post",
      "source": {
        "access_token": "((github.issues_resource_access_token))",
        "issue_prefix": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.QA deployed.",
        "issue_state": "open",
        "issue_title_template": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.QA deployed.",
        "repository": "mitodl/concourse-workflow"
      },
      "expose_build_created_by": true,
      "check_every": "1h",
      "icon": "github",
      "type": "github-issues"
    },
    {
      "name": "github-issues-applications.superset.qa-trigger",
      "source": {
        "access_token": "((github.issues_resource_access_token))",
        "issue_prefix": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.QA deployed.",
        "issue_state": "closed",
        "issue_title_template": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.QA deployed.",
        "repository": "mitodl/concourse-workflow"
      },
      "expose_build_created_by": true,
      "check_every": "1h",
      "icon": "github",
      "type": "github-issues"
    },
    {
      "name": "github-issues-applications.superset.production-post",
      "source": {
        "access_token": "((github.issues_resource_access_token))",
        "issue_prefix": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.Production deployed.",
        "issue_state": "open",
        "issue_title_template": "[bot] Pulumi ol-infrastructure-superset-server applications.superset.Production deployed.",
        "repository": "mitodl/concourse-workflow"
      },
      "expose_build_created_by": true,
      "check_every": "1h",
      "icon": "github",
      "type": "github-issues"
    }
  ]
}