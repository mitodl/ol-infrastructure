---
api:
  enabled: true

log_schema:
  timestamp_key: vector_timestamp
  host_key: log_host

sources:
  edxapp:
    type: file
    file_key: log_file
    include:
    - /var/log/edxapp/*.log
  auth_log:
    type: file
    file_key: log_file
    include:
    - /var/log/auth.log

transforms:

  edxapp_labeled_logs:
    inputs:
    - edxapp
    type: remap
    source: |
      event, err = parse_json(.message)
      if event != null {
        . = merge!(., event)
        .@timestamp = .timestamp
        .labels = ["edxapp", "${ENVIRONMENT}"]
        .application = "edxapp"
        .environment = "${ENVIRONMENT}"
      } else {
        .malformed = true
      }

  auth_log_parser:
    inputs:
    - auth_log
    type: remap
    source: |
      parsed, err = parse_syslog(.message)
      if parsed != null {
        . = merge(., parsed)
        .@timestamp = .timestamp
        del(.timestamp)
        .labels = ["authlog", "edx_authlog", "${ENVIRONMENT}"]
        .environment = "${ENVIRONMENT}"
      } else {
        .malformed = true
      }

  auth_log_malformed_message_filter:
    inputs:
    - auth_log_parser
    type: filter
    condition: .malformed != true

  auth_log_cron_filter:
    inputs:
    - auth_log_malformed_message_filter
    type: filter
    condition: .appname != "CRON"

  edxapp_enriched_logs:
    type: aws_ec2_metadata
    inputs:
    - edxapp_labeled_logs
    namespace: ec2

sinks:

  elasticsearch_lms_cms:
    inputs:
    - edxapp_enriched_logs
    type: elasticsearch
    endpoint: http://logging-elasticsearch.query.consul:9200
    index: logs-${ENVIRONMENT}-edxapp-%Y.%W
    healthcheck: false

  elasticsearch_authlog:
    inputs:
    - auth_log_cron_filter
    type: elasticsearch
    endpoint: http://logging-elasticsearch.query.consul:9200
    index: logs-${ENVIRONMENT}-authlog-%Y.%W
    healthcheck: false

  grafana_loki_logs:
    inputs:
    - edxapp_enriched_logs
    - auth_log_cron_filter
    type: loki
    auth:
      strategy: basic
      password: ${GRAFANA_CLOUD_API_KEY}
      user: "${GRAFANA_CLOUD_LOKI_API_USER}"
    endpoint: https://logs-prod-us-central1.grafana.net
    labels:
      environment: ${ENVIRONMENT}
      application: edxapp
      service: mitxonline
      hostname: ${HOSTNAME}
    out_of_order_action: rewrite_timestamp
