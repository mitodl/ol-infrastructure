---
services:
  keycloak:
    image: mitodl/keycloak:${VERSION}
    command:
    - "start --features=preview -Dkeycloak.profile.feature.upload_scripts=enabled\
      \ --spi-connections-jpa-default-migration-strategy=update"
    env_file:
    - ./.env
    labels:
    - "traefik.enable=true"
    - "traefik.http.routers.keycloak.rule=Host(`${KC_HOSTNAME}`)"
    - "traefik.http.routers.keycloak.tls.certresolver=letsencrypt_resolver"
    - "traefik.http.routers.keycloak.entrypoints=https"
    volumes:
    - /etc/docker/compose/cache-ispn-jdbc-ping.xml:/opt/keycloak/conf/cache-ispn-jdbc-ping.xml:ro
  traefik:
    image: traefik:v2.9
    command:
    - "--configFile=/etc/traefik/traefik.yaml"
    ports:
    - "80:80"
    - "443:443"
    volumes:
      # So that Traefik can listen to the Docker events
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - /etc/traefik/:/etc/traefik/
