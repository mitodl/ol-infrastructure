# -*- mode: yaml -*-
version: "3.7"

services:
  dagster-webserver:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: dagster-webserver
    restart: unless-stopped
    entrypoint: ["poetry", "run", "dagster-webserver", "-w", "/opt/dagster/app/workspace.yaml", "-h", "0.0.0.0", "-p", "3000"]
    ports:
    - ":3000"
    env_file:
      - .env
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dagit.rule=Host(`${DAGSTER_HOSTNAME}`)"
      - "traefik.http.routers.dagit.middlewares=traefik-forward-auth"
      - "traefik.http.routers.dagit.tls=true"
  dagster-daemon:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: dagster-daemon
    restart: unless-stopped
    entrypoint: ["poetry", "run", "dagster-daemon", "run", "-w", "/opt/dagster/app/workspace.yaml"]
    env_file:
      - .env
  edx-pipeline:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: edx-pipeline
    restart: unless-stopped
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.repositories.open_edx"]
    ports:
    - "4000"
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    env_file:
      - .env
  lakehouse-assets-graph:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: lakehouse-assets-graph
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.definitions.lakehouse.elt"]
    env_file:
      - .env
  tracking-log-reprocessing:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: tracking-log-reprocessing
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.definitions.edx.normalize_tracking_logs"]
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    env_file:
      - .env
  edxorg-program-credentials:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: edxorg-program-credentials
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.definitions.edx.sync_program_credential_reports"]
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    - /etc/aws/:/etc/aws/:ro
    env_file:
      - .env
  edx-gcs-courses-pipeline:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: edx-gcs-courses-pipeline
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.repositories.edx_gcs_courses"]
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    env_file:
      - .env
  edxorg-raw-data-import:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: edxorg-raw-data-import
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.definitions.edx.retrieve_irx_edx_exports"]
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    env_file:
      - .env
  openedx-ol-data-exports:
    image: {{ context.docker_repo_name }}@{{ context.docker_image_digest }}
    container_name: openedx-ol-data-exports
    restart: unless-stopped
    ports:
    - "4000"
    entrypoint: ["poetry", "run", "dagster", "api", "grpc", "-h", "0.0.0.0", "-p", "4000", "--package-name", "ol_orchestrate.definitions.edx.openedx_data_extract"]
    volumes:
    - "{{ context.edx_pipeline_definition_directory }}:/etc/dagster/:ro"
    env_file:
      - .env
  traefik:
    image: traefik:latest
    container_name: traefik
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker"
      - "--providers.docker.exposedbydefault=false"
      - "--entryPoints.http.address=:80"
      - "--entryPoints.http.http.redirections.entryPoint.to=https"
      - "--entryPoints.http.http.redirections.entryPoint.scheme=https"
      - "--entryPoints.https.address=:443"
      - "--log.level=WARN"
      - "--accesslog=true"
      - "--providers.file.filename=/traefik/traefik.yaml"
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "{{ context.traefik_directory}}/traefik.yaml:/traefik/traefik.yaml:ro"
      - "{{ context.certificate_file }}:/etc/traefik/star.odl.mit.edu.crt:ro"
      - "{{ context.certificate_key_file }}:/etc/traefik/star.odl.mit.edu.key:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
  traefik-forward-auth:
    image: thomseddon/traefik-forward-auth:2
    container_name: traefik-forward-auth
    restart: unless-stopped
    env_file:
      - .env_traefik_forward_auth
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.address=http://traefik-forward-auth:4181"
      - "traefik.http.middlewares.traefik-forward-auth.forwardauth.authResponseHeaders=X-Forwarded-User"
      - "traefik.http.services.traefik-forward-auth.loadbalancer.server.port=4181"
