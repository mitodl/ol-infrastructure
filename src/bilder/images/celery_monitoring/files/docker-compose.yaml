---
version: "2.4"
services:
  app:
    image: kodhive/leek
    environment:
      # General
    - LEEK_API_LOG_LEVEL=WARNING
    - LEEK_AGENT_LOG_LEVEL=INFO
      # Components
    - LEEK_ENABLE_API=true
    - LEEK_ENABLE_AGENT=true
    - LEEK_ENABLE_WEB=true
      # URLs
    - LEEK_API_URL=http://0.0.0.0:5000
    - LEEK_WEB_URL=http://0.0.0.0:8000
    - LEEK_ES_URL=‘elasticsearch.service.consul’
      # Authentication
    - LEEK_API_ENABLE_AUTH=false
      # Pulumi code needs to generate list of subscriptions, push them into vault,
      # and then we wire them in here via Consul template.
      # Subscriptions
      # - |
      #   LEEK_AGENT_SUBSCRIPTIONS=
      #   [
      #     {
      #       "broker": "redis://:admin@mq:6379/0",
      #       "broker_management_url": "http://mq:6379",
      #       "backend": null,
      #       "exchange": "celeryev",
      #       "queue": "leek.fanout",
      #       "routing_key": "#",
      #       "org_name": "mono",
      #       "app_name": "leek",
      #       "app_env": "prod",
      #       "prefetch_count": 1000,
      #       "concurrency_pool_size": 2,
      #       "batch_max_size_in_mb": 1,
      #       "batch_max_number_of_messages": 1000,
      #       "batch_max_window_in_seconds": 5
      #     }
      #   ]
    - LEEK_AGENT_API_SECRET=not-secret
    ports:
    - 5000:5000
    - 8000:8000
    # This seems not right. We don't have an mq target defined here? -CAP
    # depends_on:
    #   mq:
    #     condition: service_healthy
    #
