<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>consul_incantations | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/how_to/consul_incantations.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="consul_incantations">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/how_to/consul_incantations.html">
<meta property="og:description" content="Misbehaving consul cluster incident from 20231004-20231905
Overview
At some point operations-production consul cluster fell over and stopped being useful. The root cause was not immediately know but w">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="consul_incantations.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="../discoveries/" class="dropdown-item">Discoveries</a>
                    <a href="." class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">consul_incantations</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h2>Misbehaving consul cluster incident from 20231004-20231905</h2>
<h2>Overview</h2>
<p>At some point <code>operations-production</code> consul cluster fell over and stopped being useful. The root cause was not immediately know but was almost definitely related to an upgrade to <code>1.16.2</code> from <code>???</code> (no good record indication what the cluster was on before all this went down...)</p>
<p>Key takeaway from the logs was this cryptic message about being unable to restore snapshot:</p>
<div class="code"><pre class="code literal-block"><span class="err">{</span><span class="ss">"@level"</span><span class="err">:</span><span class="ss">"error"</span><span class="p">,</span><span class="ss">"@message"</span><span class="err">:</span><span class="ss">"failed to restore snapshot"</span><span class="p">,</span><span class="ss">"@module"</span><span class="err">:</span><span class="ss">"agent.server.raft"</span><span class="p">,</span><span class="ss">"@timestamp"</span><span class="err">:</span><span class="ss">"2023-10-04T14:17:40.200037Z"</span><span class="p">,</span><span class="ss">"error"</span><span class="err">:</span><span class="ss">"failed to restore snapshot 1156-86945697-1696429059987: failed inserting acl token: missing value for index 'accessor'"</span><span class="err">}</span>
</pre></div>

<p>This is something that happens anytime a consul server restarts, it gets a copy of the raft from the other servers currently running and restores it. But, it is failing to do that and crashing.</p>
<h2>Initial Response</h2>
<p>Tobias was able to revive the cluster by downgrading it to 1.14.10 and it was then able to restore the snapshot it received from other nodes / on the filesystem (unclear how broken the cluster was at this time).</p>
<h2>Research</h2>
<p>Looking up that message returned <a href="https://discuss.hashicorp.com/t/consul-accessorid-is-empty-in-one-of-remote-clusters/53191">one very-not-promising result</a> from the hashicorp forums.</p>
<h2>Resolution</h2>
<p>Ultimitely spent a lot of time reading and pursuing dead ends but what <em>I believe</em> ulimitely resolved the issue was the following:</p>
<ol>
<li>Step through each consul server in the cluster and ensure:
  a. it is on version 1.14.10
  b. It has this acl stanza in <code>00-default.json</code>: <code>"acl": {"enabled":  true, "default_policy": "allow", "enable_token_persistence": false}</code>
  c. Restart the servers one at a time to ensure the quorum never drops below 3 (or 2 if you're in non-prod).</li>
<li>Now you should be able to issue <code>acl</code> commands using the consul cli.
  a. They won't work though because you don't have a token and in this particular case the cluster says it is not elgible for bootstrapping.
  b. At some point in history this very special cluster had ACLs enabled and then disabled? Possibly?</li>
<li>We need to reset/recover the ACL master token. Follow the procedure <a href="https://github.com/hashicorp/consul/issues/5331#issuecomment-462772868">here</a>.</li>
<li>The output of that command should be "Bootstrap Token (Global Management)" an <code>AccessorID</code> and <code>SecretID</code>. Export the secret ID in your terminal as <code>CONSUL_HTTP_TOKEN</code>.</li>
<li>Then you can do <code>consul acl token list</code> and one of them should be labeled "Master Token".
  a. export the <code>SecretID</code> from the Master Token as <code>CONSUL_HTTP_TOKEN</code> or just save it off somewhere.</li>
<li>Repeat step 1, loop through all the servers and remove the <code>acl</code> stanza, restarting one at a time to ensure quorum.</li>
<li>Once all nodes are running again and ACL is disabled, start upgrading the nodes. one at a time, to 1.16.2.</li>
</ol>
<div class="code"><pre class="code literal-block"><span class="n">wget</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">releases</span><span class="o">.</span><span class="n">hashicorp</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">consul</span><span class="o">/</span><span class="mf">1.16</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">consul_1</span><span class="o">.</span><span class="mf">16.2</span><span class="n">_linux_amd64</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span><span class="w"> </span><span class="n">consul_1</span><span class="o">.</span><span class="mf">16.2</span><span class="n">_linux_amd64</span><span class="o">.</span><span class="n">zip</span>
<span class="n">mv</span><span class="w"> </span><span class="n">consul</span><span class="w"> </span><span class="n">consul_1_16_2</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">consul</span>
<span class="n">cp</span><span class="w"> </span><span class="n">consul_1_16_2</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">consul</span>
<span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span>
<span class="n">cp</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="n">consul</span><span class="w"> </span><span class="n">consul_bak</span>
<span class="n">cd</span><span class="w"> </span><span class="n">consul</span>
<span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="n">serf</span><span class="o">/</span><span class="w"> </span><span class="n">raft</span><span class="o">/</span><span class="w"> </span><span class="n">server_metadata</span><span class="o">.</span><span class="n">json</span><span class="w"> </span><span class="n">checkpoint</span><span class="o">-</span><span class="n">signature</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">consul</span>
</pre></div>

<ol>
<li>Verify quorum: <code>consul operator raft list-peers</code>
</li>
<li>Verify version: <code>consul members</code> and <code>consul version</code>
</li>
</ol>
</div>
    

</article><!--End of body content--><footer id="footer">
            Contents © 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
