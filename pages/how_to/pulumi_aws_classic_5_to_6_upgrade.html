<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>pulumi_aws_classic_5_to_6_upgrade | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/how_to/pulumi_aws_classic_5_to_6_upgrade.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="pulumi_aws_classic_5_to_6_upgrade">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/how_to/pulumi_aws_classic_5_to_6_upgrade.html">
<meta property="og:description" content="So, this is roughly what I believe is happening. So you guys can know too.

I updated / tested a bunch of stacks, mostly CI or sometimes QA, yesterday with the pulumi-aws 6.5.0 upgrade. That is a two ">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="pulumi_aws_classic_5_to_6_upgrade.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="../discoveries/" class="dropdown-item">Discoveries</a>
                    <a href="." class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">pulumi_aws_classic_5_to_6_upgrade</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>So, this is roughly what I believe is happening. So you guys can know too.</p>
<ol>
<li>I updated / tested a bunch of stacks, mostly CI or sometimes QA, yesterday with the <code>pulumi-aws 6.5.0</code> upgrade. That is a two part thing. Python package but also provider.</li>
<li>Part of that upgrade, pulumi changed some of the state/stack structures and they are no longer backwards compatible, in particular those around RDS instances.</li>
<li>So I, by hand, upgraded a bunch of stacks to the new provider, they migrate nicely everything is good.</li>
<li>Concourse comes around and something triggers it and it applies the stacks again but with the old provider. It works okay the first time, but when the second time comes around it decides it has lost track of the RDS instance and it tries to recreate it.</li>
<li>If it DOES try to recreate it, thankfully it fails, because the RDS instance is still there, just pulumi has lost it, and a duplicate error gets thrown and the apply/up fails.</li>
<li>But, now the stack is broken and requires manual intervention to revive it.<ul>
<li>So what I do is I go into the history/checkpoint area in S3 and find the most recent checkpoint that references the 6.5.0 provider (the one I upgraded to). I pull that down.</li>
<li>Checkpoints can’t be imported directly they need to be fixed. Fix it with this: <a href="https://gist.github.com/clstokes/977b7bd00b37e0a564f707f0ebe36e08">https://gist.github.com/clstokes/977b7bd00b37e0a564f707f0ebe36e08</a>
</li>
<li><code>pr pulumi stack import -s &lt;stackname&gt; --file &lt;fixed stack checkpoint file&gt;</code></li>
<li>
<code>poetry install</code> using an environment pre-6.5.0 upgrade if necessary (I keep multiple ol-inf envs for exactly this kind of thing so I just switch between my 5.4 and 6.5 envs).</li>
<li>
<code>pulumi plugin rm resource aws 6.5.0</code> uninstall the PROVIDER</li>
<li>
<code>pr pulumi up --refresh -s &lt;stackname&gt;</code> x2 — Shouldn’t be trying to create a database anymore.</li>
</ul>
</li>
<li>Many of the stacks were fine because they either:<ul>
<li>didn’t have RDS resources</li>
<li>didn’t get up’d by concourse inbetween.</li>
</ul>
</li>
<li>BUT! BUT! When the PR making this upgrade was merged to <code>main</code> , it trigged nearly everything. Very sad. :disappointed:<ul>
<li>But the code has been merged so that is fine right? Wrong.</li>
<li>The resources that concourse uses to do the needful are not upgraded yet. Specifically these:<ul>
<li><a href="https://hub.docker.com/r/mitodl/concourse-pulumi-resource-provisioner">https://hub.docker.com/r/mitodl/concourse-pulumi-resource-provisioner</a></li>
<li><a href="https://hub.docker.com/r/mitodl/concourse-pulumi-resource">https://hub.docker.com/r/mitodl/concourse-pulumi-resource</a></li>
<li><a href="https://hub.docker.com/r/mitodl/ol-infrastructure">https://hub.docker.com/r/mitodl/ol-infrastructure</a></li>
</ul>
</li>
<li>These actually have a complicated silent depedency between them, but basically <code>mitodl/ol-infrastructure</code> is a base layer for the other two.</li>
<li>These builds also kicked off (maybe? I did run them by hand too…) when the PR was merged but they didn’t publish to dockerhub before concourse started trying to update CI/QA stacks automatically.<ul>
<li>EVEN IF they had published to dockerhub before, it wouldn’t matter because servers-be-cachin’.</li>
<li>The concourse workers were holding on to their old versions and efficiently re-using them, ignorant of the new versions available out on dockerhub.</li>
<li>Solve this by doing and instance refresh on concourse workers. New servers do new <code>docker pull</code> on the resources needed.</li>
</ul>
</li>
</ul>
</li>
<li>Addendum: Made a neat script to pause concourse pipelines en-mass. Should have run this before #8 :disappointed:</li>
</ol>
<div class="code"><pre class="code literal-block"><span class="k">for</span><span class="w"> </span>pl<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>fly<span class="w"> </span>-t<span class="w"> </span>pr-inf<span class="w"> </span>ps<span class="w"> </span>--json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">'.[].name'</span><span class="k">)</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>fly<span class="w"> </span>-t<span class="w"> </span>pr-inf<span class="w"> </span>pp<span class="w"> </span>-p<span class="w"> </span><span class="nv">$pl</span>
<span class="k">done</span>
</pre></div>
    </div>
    

</article><!--End of body content--><footer id="footer">
            Contents © 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
