<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>deploying_concourse | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/how_to/deploying_concourse.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="deploying_concourse">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/how_to/deploying_concourse.html">
<meta property="og:description" content="Summary
This document will detail the best practice we use to develop and deploy changes
to our Concourse pipeline web and worker servers.
Developing
As with most projects here at MIT OL's Devops team">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="deploying_concourse.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="../discoveries/" class="dropdown-item">Discoveries</a>
                    <a href="." class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">deploying_concourse</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h2>Summary</h2>
<p>This document will detail the best practice we use to develop and deploy changes
to our Concourse pipeline web and worker servers.</p>
<h3>Developing</h3>
<p>As with most projects here at MIT OL's Devops team, you'll want to start by
checking out the
<a href="https://github.com/mitodl/ol-infrastructure/">ol-infrastructure</a> project to
your local workspace.</p>
<p>As usual, be sure to run <code>poetry install</code> so all the right dependencies will be
cached and ready to run your newly changed <a href="https://pyinfra.com/">pyinfra</a> code.</p>
<p>Now change directory to the src/bilder/images/concourse folder. Here you'll see
a number of files. The most important for our purposes is
<a href="https://github.com/mitodl/ol-infrastructure/blob/main/src/bilder/images/concourse/deploy.py">deploy.py</a>.</p>
<p>Very likely, any chances you might want to make will be in this file.</p>
<h3>Local Testing</h3>
<p>Apparently I'm alone on this bus, but I personally enjoy testing changes on my
machine before I commit them to Git. The testing doesn't have to be deep,
something like syntax and being end to end runnable are good enough for me.</p>
<p>In any case, in order to locally build the docker container, run the following
command:</p>
<p><code>pyinfra @docker/debian:bookworm deploy.py</code></p>
<p><strong>NOTA BENE</strong>: I am not entirely sure about the Debian Bookworm base container
I'm using here, it worked well enough for my very shallow testing purposes.</p>
<p><strong>TODO</strong>: Figure out what we actually use for a base container and cite that in
this doc.</p>
<p>If you have a syntax error or an error in your pyinfra code that prevents the
container from building, you will see that on your screen and can debug it
accordingly.  Otherwise, you'll see a message about the container building
successfully.</p>
<h3>Build The Image</h3>
<p>Now that we've very shallowly 'smoke tested' our code, let's run the actual
official script to build the AMI with packer and stage it for later deployment.</p>
<p>From the same directory, run the following command:</p>
<p><code>pr packer build -on-error=ask -var node_type=web -var app_name=concourse -only amazon-ebs.third-party src/bilder/images</code></p>
<p>You will see a LOT of output and the process could take up to 20 minutes.</p>
<h3>Initial Testing in CI</h3>
<p>For most of the rest of the journey to production, you'll be using a pipeline
rather than doing it by hand with Pulumi, but for your first time, you'll
probably want to do it by hand and then minutely monitor the resultant deployed
image in CI to ensure everything went smoothly.</p>
<p><strong>TODO: Add curl smoke test for web node</strong></p>
<h3>Deployment to QA and Beyond</h3>
<p>For the remainder of your change's journey through QA and ultimately to
production, you'll be using the <a href="https://cicd.odl.mit.edu/teams/infrastructure/pipelines/packer-pulumi-concourse">Concourse
pipeline</a>.</p>
<p><strong>TODO: Add further testing details</strong></p>
    </div>
    

</article><!--End of body content--><footer id="footer">
            Contents Â© 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
