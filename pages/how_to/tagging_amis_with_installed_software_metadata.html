<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tagging_amis_with_installed_software_metadata | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/how_to/tagging_amis_with_installed_software_metadata.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="tagging_amis_with_installed_software_metadata">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/how_to/tagging_amis_with_installed_software_metadata.html">
<meta property="og:description" content="Tagging AMIs with Installed Software Metadata
Background
We are looking to start a new pattern where each AMI we produce is tagged with metadata about the software installed on it. This included 3rd p">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="tagging_amis_with_installed_software_metadata.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="../discoveries/" class="dropdown-item">Discoveries</a>
                    <a href="." class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">tagging_amis_with_installed_software_metadata</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h2>Tagging AMIs with Installed Software Metadata</h2>
<h3>Background</h3>
<p>We are looking to start a new pattern where each AMI we produce is tagged with metadata about the software installed on it. This included 3rd party software such as Hashicorp products as well as information our applications. Recently we've been asked 'What version of X is running in production right now?" and it was a surprisingly difficult question to answer. The idea behind this new pattern is to change that, by providing the required information simply by inspecting the AMI behind any running EC2 instance.</p>
<h2>Implementation</h2>
<p>We use <a href="https://pyinfra.com/">pyinfra</a> to do most of the operations involved with creating a new AMI and this is no exception.</p>
<p>Firstly, during the new build we will create a file on the build instance at <code>/etc/ami_tags.json</code> which contains our tag keys and values.</p>
<div class="code"><pre class="code literal-block"><span class="kn">from</span><span class="w"> </span><span class="nn">bilder.lib.ami_helpers</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">build_tags_document</span>
<span class="n">tags_json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
<span class="w">    </span><span class="n">build_tags_document</span><span class="p">(</span>
<span class="w">        </span><span class="n">source_tags</span><span class="o">=</span><span class="p">{</span>
<span class="w">            </span><span class="s2">"consul_version"</span><span class="p">:</span><span class="w"> </span><span class="n">VERSIONS</span><span class="p">[</span><span class="s2">"consul"</span><span class="p">],</span>
<span class="w">            </span><span class="s2">"consul_template_version"</span><span class="p">:</span><span class="w"> </span><span class="n">VERSIONS</span><span class="p">[</span><span class="s2">"consul-template"</span><span class="p">],</span>
<span class="w">            </span><span class="s2">"vault_version"</span><span class="p">:</span><span class="w"> </span><span class="n">VERSIONS</span><span class="p">[</span><span class="s2">"vault"</span><span class="p">],</span>
<span class="w">            </span><span class="s2">"docker_repo"</span><span class="p">:</span><span class="w"> </span><span class="n">DOCKER_REPO_NAME</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"docker_digest"</span><span class="p">:</span><span class="w"> </span><span class="n">DOCKER_IMAGE_DIGEST</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"edxapp_repo"</span><span class="p">:</span><span class="w"> </span><span class="n">edx_platform</span><span class="o">.</span><span class="n">git_origin</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"edxapp_branch"</span><span class="p">:</span><span class="w"> </span><span class="n">edx_platform</span><span class="o">.</span><span class="n">release_branch</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"edxapp_sha"</span><span class="p">:</span><span class="w"> </span><span class="n">edx_platform_sha</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"theme_repo"</span><span class="p">:</span><span class="w"> </span><span class="n">theme</span><span class="o">.</span><span class="n">git_origin</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"theme_branch"</span><span class="p">:</span><span class="w"> </span><span class="n">theme</span><span class="o">.</span><span class="n">release_branch</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"theme_sha"</span><span class="p">:</span><span class="w"> </span><span class="n">theme_sha</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">)</span>
<span class="n">files</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
<span class="w">    </span><span class="n">name</span><span class="o">=</span><span class="s2">"Place the tags document at /etc/ami_tags.json"</span><span class="p">,</span>
<span class="w">    </span><span class="n">src</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">tags_json</span><span class="p">),</span>
<span class="w">    </span><span class="n">dest</span><span class="o">=</span><span class="s2">"/etc/ami_tags.json"</span><span class="p">,</span>
<span class="w">    </span><span class="n">mode</span><span class="o">=</span><span class="s2">"0644"</span><span class="p">,</span>
<span class="w">    </span><span class="n">user</span><span class="o">=</span><span class="s2">"root"</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>

<p>This file persists as part of the AMI and will exist on any instances spawned from the image.</p>
<p>Next, we need to add three steps to our packer <code>build</code> stanza.</p>
<p>First, we need to retrieve the file we just created remotely in the pyinfra code. We use the same SSH information that we utilized when we ran <code>pyinfra</code>. This needs to be a <code>provisioner</code> step because the build instance still needs to be running in order to copy a file from it.</p>
<div class="code"><pre class="code literal-block">provisioner<span class="w"> </span>"shell-local"<span class="w"> </span>{
<span class="w">  </span>inline<span class="w"> </span>=<span class="w"> </span>["scp<span class="w"> </span>-o<span class="w"> </span>StrictHostKeyChecking=no<span class="w"> </span>-i<span class="w"> </span>/tmp/packer-<span class="cp">${</span><span class="n">build</span><span class="o">.</span><span class="n">ID</span><span class="cp">}</span>.pem<span class="w"> </span><span class="cp">${</span><span class="n">build</span><span class="o">.</span><span class="n">User</span><span class="cp">}</span>@<span class="cp">${</span><span class="n">build</span><span class="o">.</span><span class="n">Host</span><span class="cp">}</span>:/etc/ami_tags.json<span class="w"> </span>/tmp/ami_tags-<span class="cp">${</span><span class="n">build</span><span class="o">.</span><span class="n">ID</span><span class="cp">}</span>.json"]
}
</pre></div>

<p>Second, we create a <code>post-processor</code> that generates a <code>packer manifest</code> for the build. This is just a json file local to the machine running the packer build (not the remote ec2 build instance as before). Because this is the first <code>post-processor</code> and follows the last <code>provisioner</code> step, the remote EC2 instance has been terminated and an AMI has been generated. The manifest will contain the AMI ID which is needed for the next step.</p>
<div class="code"><pre class="code literal-block">post-processor<span class="w"> </span>"manifest"<span class="w"> </span>{
<span class="w">  </span>output<span class="w"> </span>=<span class="w"> </span>"/tmp/packer-build-manifest-<span class="cp">${</span><span class="n">build</span><span class="o">.</span><span class="n">ID</span><span class="cp">}</span>.json"
}
</pre></div>

<p>Finally, we will take the AMI ID out of the <code>packer manifest</code> and combined with the <code>ami_tags.json</code> file we will make a <code>create-tags</code> call on the newly created AMI to add our metadata to it.</p>
<div class="code"><pre class="code literal-block"><span class="n">post</span><span class="o">-</span><span class="n">processor</span><span class="w"> </span><span class="s2">"shell-local"</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">inline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">"AMI_ID=$(jq -r '.builds[-1].artifact_id' /tmp/packer-build-manifest-${build.ID}.json | cut -d </span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2"> -f2)"</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"export AWS_DEFAULT_REGION=us-east-1"</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"aws ec2 create-tags --resource $AMI_ID --cli-input-json </span><span class="se">\"</span><span class="s2">$(cat /tmp/ami_tags-${build.ID}.json)</span><span class="se">\"</span><span class="s2">"</span><span class="p">,</span>
<span class="w">            </span><span class="s2">"aws --no-cli-pager ec2 describe-images --image-ids $AMI_ID"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
    </div>
    

</article><!--End of body content--><footer id="footer">
            Contents © 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
