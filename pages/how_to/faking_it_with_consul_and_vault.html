<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>faking_it_with_consul_and_vault | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/how_to/faking_it_with_consul_and_vault.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="faking_it_with_consul_and_vault">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/how_to/faking_it_with_consul_and_vault.html">
<meta property="og:description" content="Faking it with Consul and Vault
Why?
Sometimes you want to test an AMI build process without all all the supporting stuff that allows an EC2 instance to talk to vault and consul like a good little box">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="faking_it_with_consul_and_vault.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="../discoveries/" class="dropdown-item">Discoveries</a>
                    <a href="." class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">faking_it_with_consul_and_vault</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h2>Faking it with Consul and Vault</h2>
<h3>Why?</h3>
<p>Sometimes you want to test an AMI build process without all all the supporting stuff that allows an EC2 instance to talk to vault and consul like a good little box. All that supporting stuff typically happens are instance start time and rides in on <code>user_data</code> which you don't have if you fired up an EC2 by hand just to see what your AMI looks like so far.</p>
<p>So, for development purposes here is an abbreviated guide of faking it until you make it.</p>
<h3>Consul</h3>
<ol>
<li>From a like-minded instance, find the proper IAM instance profile ARN. In my case I'm making a new type of EC2 box for edxapp / mite-staging / ci, so I went to one of the existing boxes for that environment, copied the Instance Profile ARN and associated it to my new, one-off, manually created EC2 box. This is essential.</li>
<li>Second, from the same like-minded instance, nab <code>/etc/consul.d/99-autojoin.json</code>.</li>
</ol>
<div class="code"><pre class="code literal-block">{"retry_join": ["provider=aws tag_key=consul_env tag_value=mitx-staging-ci"], "datacenter": "mitx-staging-ci"}
</pre></div>

<ol>
<li>Copy that config to your one-off box and restart consul and confirm you are now joined to the cluster with <code>consul catalog nodes</code> or whatever you fancy.</li>
</ol>
<h3>Vault</h3>
<p>This requires using vault &gt;= 1.13.x which introduced the <code>token_file</code> auto_auth method.</p>
<ol>
<li>On your one-off EC2 box, backup the existing <code>/etc/vault/vault.json</code> file and change the auto_auth block to be like the following:</li>
</ol>
<div class="code"><pre class="code literal-block"><span class="w">  </span><span class="s">"auto_auth"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">"method"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">"type"</span><span class="p">:</span><span class="w"> </span><span class="s">"token_file"</span><span class="p">,</span>
<span class="w">      </span><span class="s">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"token_file_path"</span><span class="p">:</span><span class="w"> </span><span class="s">"/etc/vault/vault_token"</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">"sink"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="s">"type"</span><span class="p">:</span><span class="w"> </span><span class="s">"file"</span><span class="p">,</span>
<span class="w">        </span><span class="s">"derive_key"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="s">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="s">"path"</span><span class="p">:</span><span class="w"> </span><span class="s">"/etc/vault/vault_agent_token"</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
</pre></div>

<ol>
<li>In the vault UI, top right side little man icon, click 'Copy Token' and put that into <code>/etc/vault/vault_token</code>
</li>
</ol>
<div class="code"><pre class="code literal-block">echo -n "&lt;token&gt;" &gt; /etc/vault/vault_token
</pre></div>

<ol>
<li>Restart vault and verify that it is happy and healthy.</li>
</ol>
<h3>Disclaimer</h3>
<p>You basically just gave this node a root token to vault ... so, you know ... don't do this anywhere besides CI and don't leave it hanging around. This is just for debugging.</p>
    </div>
    

</article><!--End of body content--><footer id="footer">
            Contents Â© 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
