<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>fargate_service_discovery | Platform Engineering Site</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Playfair+Display:700,900" rel="stylesheet">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://pe.ol.mit.edu/pages/discoveries/fargate_service_discovery.html">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="MIT Online Learning Platform Engineering">
<meta property="og:site_name" content="Platform Engineering Site">
<meta property="og:title" content="fargate_service_discovery">
<meta property="og:url" content="https://pe.ol.mit.edu/pages/discoveries/fargate_service_discovery.html">
<meta property="og:description" content="Integrating Fargate Services Into Our Existing Systems Architecture
The Goal
We want to start using ECS Fargate from AWS as a low-complexity way of running
containerized workloads. It allows us to spe">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2024-06-27T16:57:52-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Header and menu bar -->
<div class="container">
      <header class="blog-header py-3"><div class="row nbb-header align-items-center">
          <div class="col-md-3 col-xs-2 col-sm-2" style="width: auto;">
            <button class="navbar-toggler navbar-light bg-light nbb-navbar-toggler" type="button" data-toggle="collapse" data-target=".bs-nav-collapsible" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse bs-nav-collapsible bootblog4-search-form-holder">
                
            </div>
        </div>
          <div class="col-md-6 col-xs-10 col-sm-10 bootblog4-brand" style="width: auto;">
            <a class="navbar-brand blog-header-logo text-dark" href="../../">

            <span id="blog-title">Platform Engineering Site</span>
        </a>
          </div>
            <div class="col-md-3 justify-content-end align-items-center bs-nav-collapsible collapse flex-collapse bootblog4-right-nav">
            <nav class="navbar navbar-light bg-white"><ul class="navbar-nav bootblog4-right-nav">
<li class="nav-item">
    <a href="fargate_service_discovery.md" id="sourcelink" class="nav-link">Source</a>
    </li>


                    
            </ul></nav>
</div>
    </div>
</header><nav class="navbar navbar-expand-md navbar-light bg-white static-top"><div class="collapse navbar-collapse bs-nav-collapsible" id="bs-navbar">
            <ul class="navbar-nav nav-fill d-flex w-100"><li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pages</a>
            <div class="dropdown-menu">
                    <a href="../runbooks/" class="dropdown-item">Runbooks</a>
                    <a href="." class="dropdown-item">Discoveries</a>
                    <a href="../how_to/" class="dropdown-item">How To</a>
                    <a href="../post-mortems/" class="dropdown-item">Post Mortems</a>
            </div>

                
            </li></ul>
</div>
<!-- /.navbar-collapse -->
</nav>
</div>

<div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="#" class="u-url">fargate_service_discovery</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h2>Integrating Fargate Services Into Our Existing Systems Architecture</h2>
<h3>The Goal</h3>
<p>We want to start using ECS Fargate from AWS as a low-complexity way of running
containerized workloads. It allows us to specify a set of containers that we would like
to run as a single task, with simple autoscaling and resource allocation, and no need to
manage the underlying servers. At face value this is a great option, even with the
slight cost markup that it brings. It is highly likely that we will save at least that
much money in engineering time.</p>
<h3>The Challenges</h3>
<p>In order for us to properly integrate applications and services into our infrastructure,
we need to be able to connect them to our Vault and Consul clusters. This allows us to
expose the services that they provide to our other systems, as well as allowing us to
simplify the configuration needed to let those applications connect to other system
components. In an EC2 environment this is as simple as running a Consul and Vault agent,
and setting up DNS routing to use the Consul agent running on localhost.</p>
<p>Fargate makes this challenging due to the set of (reasonable) constraints that it places
on the tasks that it runs. Among these is the fact that it can only use the DNS server
at the VPC level for address resolution. This is due to its use of an Elastic Network
Interface (ENI) for network traffic. It is possible for containers to communicate with
their peer containers in a task group over localhost connections, but since DNS is a
privileged process it is not straightforward to force those queries to rely on a sidecar
in the grouping. Because it is not possible to use Consul as the DNS provider, it
complicates the configuration of Vault agents for locating the server cluster that it
needs to authenticate to.</p>
<h3>The Solution</h3>
<p>In order to work around these constraints it is possible to use the AWS Cloud Map
service as a means of registering and discovering services across our
infrastructure. This in conjunction with the
<a href="https://github.com/hashicorp/consul-aws/">consul-aws</a> application provides a means of
setting up a bi-directional sync of services registered in Consul and services
registered in <a href="https://aws.amazon.com/cloud-map/">AWS Cloud Map</a>. By registering a
cloud-map namespace for each of our VPCs and creating an ECS Fargate task to execute the
consul-aws synchronization, we can maintain a consistent view of what services are
available, regardless of whether they are communicating with the cloud-map DNS or the
Consul DNS.</p>
<h3>Design Challenges</h3>
<p>While the use of Consul and AWS Cloud Map provides a low-complexity means of keeping
things in sync, it does provide some friction in how applications are configured. This
is due to the fact that the DNS names for a given service will be different depending on
which system is being queried. For a service being discovered via Consul the query would
be <code>&lt;service_name&gt;.service.consul</code>, whereas in AWS Cloud-Map it would be
<code>&lt;service_name&gt;.&lt;cloud-map_namespace&gt;</code>. This is largely a manageable problem, since it
will be primarily Fargate processes that need to interact with cloud-map and most other
systems will use Consul, but it will require a clear understanding of which processes
are communicating in which contexts.</p>
    </div>
    

</article><!--End of body content--><footer id="footer">
            Contents Â© 2024         <a href="mailto:ol-devops@mit.edu">MIT Online Learning Platform Engineering</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
