---
resource_types:
- name: rclone
  type: docker-image
  source:
    repository: sothr/concourse-rclone-resource
    tag: latest

resources:
- name: mfe-app-learning
  type: git
  source:
    uri: https://github.com/edx/frontend-app-learning.git
    branch: master
- name: mfe-app-learning-bucket
  type: rclone
  source:
    config: |
      [s3-remote]
      type = s3
      provider = AWS
      env_auth = true
      region = us-east-1

jobs:
- name: build
  plan:
  - get: mfe-app-learning
    trigger: true
  - task: npm-install-and-build
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: node
      inputs:
      - name: mfe-app-learning
      outputs:
      - name: mfe-app-learning/dist
      params:
        ACCESS_TOKEN_COOKIE_NAME: edx-jwt-cookie-header-payload
        BASE_URL: https://courses.mitxonline.mit.edu
        CSRF_TOKEN_API_PATH: /csrf/api/v1/token
        LMS_BASE_URL: https://courses.mitxonline.mit.edu
        LOGIN_URL: https://courses.mitxonline.mit.edu/login
        LOGOUT_URL: https://courses.mitxonline.mit.edu/logout
        LOGO_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        LOGO_TRADEMARK_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        LOGO_WHITE_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        FAVICON_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/favicon.ico
        MARKETING_SITE_BASE_URL: https://mitxonline.mit.edu
        PUBLIC_PATH: /learn/
        REFRESH_ACCESS_TOKEN_ENDPOINT: https://courses.mitxonline.mit.edu/login_refresh
        SEARCH_CATALOG_URL: https://courses.mitxonline.mit.edu/courses
        SITE_NAME: MITx Online
        STUDIO_BASE_URL: https://studio.mitxonline.mit.edu
        USER_INFO_COOKIE_NAME: edx-user-info
        SESSION_COOKIE_DOMAIN: .mitxonline.mit.edu
      run:
        path: sh
        dir: mfe-app-learning
        args:
        - -exc
        - |
          npm install
          NODE_ENV=production npm run build
  - put: mfe-app-learning-bucket
    params:
      source: mfe-app-learning/dist
      destination:
      - command: sync
        dir: s3-remote:mitxonline-production-edxapp-mfe/learn/
