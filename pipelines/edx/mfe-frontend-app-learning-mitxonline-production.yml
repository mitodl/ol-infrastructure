---
resource_types:
- name: rclone
  type: docker-image
  source:
    repository: mitodl/concourse-rclone-resource
    tag: latest

resources:
- name: mfe-app-learning
  type: git
  source:
    uri: https://github.com/edx/frontend-app-learning.git
    branch: master
- name: mfe-app-learning-bucket
  type: rclone
  source:
    config: |
      [s3-remote]
      type = s3
      provider = AWS
      env_auth = true
      region = us-east-1

jobs:
- name: build
  plan:
  - get: mfe-app-learning
    trigger: false
  - task: npm-install-and-build
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: node
          tag: 16-bullseye-slim
      inputs:
      - name: mfe-app-learning
      outputs:
      - name: mfe-app-learning/dist
      params:
        ABOUT_US_URL: https://mitxonline.mit.edu/about-us/
        ACCESS_TOKEN_COOKIE_NAME: mitxonline-production-edx-jwt-cookie-header-payload
        BASE_URL: https://courses.mitxonline.mit.edu/learn
        CSRF_TOKEN_API_PATH: /csrf/api/v1/token
        Contact: https://mitxonline.zendesk.com/hc/en-us/requests/new
        FAVICON_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/favicon.ico
        HONOR_CODE_URL: https://mitxonline.mit.edu/honor-code/
        LMS_BASE_URL: https://courses.mitxonline.mit.edu
        LOGIN_URL: https://courses.mitxonline.mit.edu/login
        LOGOUT_URL: https://courses.mitxonline.mit.edu/logout
        LOGO_ALT_TEXT: ''
        LOGO_TRADEMARK_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        LOGO_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        LOGO_WHITE_URL: https://raw.githubusercontent.com/mitodl/mitxonline-theme/main/lms/static/images/logo.png
        MARKETING_SITE_BASE_URL: https://mitxonline.mit.edu
        ORDER_HISTORY_URL:
        PRIVACY_POLICY_URL: https://mitxonline.mit.edu/privacy-policy/
        PUBLIC_PATH: /learn/
        REFRESH_ACCESS_TOKEN_ENDPOINT: https://courses.mitxonline.mit.edu/login_refresh
        SEARCH_CATALOG_URL: https://courses.mitxonline.mit.edu/courses
        SESSION_COOKIE_DOMAIN: .mitxonline.mit.edu
        SITE_NAME: MITx Online
        SITE_URL: https://mitxonline.mit.edu
        STUDIO_BASE_URL: https://studio.mitxonline.mit.edu
        SUPPORT_CENTER_TEXT: Support Center
        SUPPORT_CENTER_URL: https://mitxonline.zendesk.com/hc/en-us
        SUPPORT_URL: https://mitxonline.zendesk.com/hc/en-us
        TERMS_OF_SERVICE_URL: https://mitxonline.mit.edu/terms-of-service/
        TRADEMARK_TEXT: Â© MITxOnline. All rights reserved except where noted.
        USER_INFO_COOKIE_NAME: mitxonline-production-edx-user-info
      run:
        path: sh
        dir: mfe-app-learning
        args:
        - -exc
        - |
          npm install
          npm install @edx/frontend-component-footer@npm:@mitodl/frontend-component-footer-mitol@latest --legacy-peer-deps
          npm install @edx/frontend-component-header@npm:@mitodl/frontend-component-header-mitol@latest --legacy-peer-deps
          npm install @edx/frontend-lib-special-exams@1.16.1 --legacy-peer-deps
          NODE_ENV=production npm run build
  - put: mfe-app-learning-bucket
    params:
      source: mfe-app-learning/dist
      destination:
      - command: sync
        dir: s3-remote:mitxonline-production-edxapp-mfe/learn/
