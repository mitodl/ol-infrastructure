---
resource_types:
- name: rclone
  type: docker-image
  source:
    repository: mitodl/concourse-rclone-resource
    tag: latest

resources:
- name: mfe-app-gradebook
  type: git
  source:
    uri: https://github.com/edx/frontend-app-gradebook.git
    branch: open-release/maple.master
- name: mfe-app-bucket
  type: rclone
  source:
    config: |
      [s3-remote]
      type = s3
      provider = AWS
      env_auth = true
      region = us-east-1

jobs:
- name: build
  plan:
  - get: mfe-app-gradebook
    trigger: true
  - task: npm-install-and-build
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: node
          tag: 14-bullseye-slim
      inputs:
      - name: mfe-app-gradebook
      outputs:
      - name: mfe-app-gradebook/dist
      params:
        ACCESS_TOKEN_COOKIE_NAME: xpro-qa-edx-jwt-cookie-header-payload
        BASE_URL: https://courses-rc.xpro.mit.edu
        CSRF_TOKEN_API_PATH: /csrf/api/v1/token
        FAVICON_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/favicon.ico
        LMS_BASE_URL: https://courses-rc.xpro.mit.edu
        LOGIN_URL: https://courses-rc.xpro.mit.edu/login
        LOGOUT_URL: https://courses-rc.xpro.mit.edu/logout
        LOGO_TRADEMARK_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        LOGO_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        LOGO_WHITE_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        MARKETING_SITE_BASE_URL: https://rc.xpro.mit.edu
        ORDER_HISTORY_URL:
        PUBLIC_PATH: /gradebook/
        REFRESH_ACCESS_TOKEN_ENDPOINT: https://courses-rc.xpro.mit.edu/login_refresh
        SEARCH_CATALOG_URL: https://courses-rc.xpro.mit.edu/courses
        SESSION_COOKIE_DOMAIN: courses-rc.mitxpro.mit.edu
        SITE_NAME: MIT xPRO
        STUDIO_BASE_URL: https://studio-rc.xpro.mit.edu
        SUPPORT_URL: https://xpro.zendesk.com/hc
        USER_INFO_COOKIE_NAME: xpro-qa-edx-user-info
      run:
        path: sh
        dir: mfe-app-gradebook
        args:
        - -exc
        - |
          apt-get update
          apt-get install -q -y python build-essential
          npm install
          npm install @edx/frontend-component-footer@npm:@mitodl/frontend-component-footer-mitol@latest --legacy-peer-deps
          npm install @edx/frontend-component-header@npm:@mitodl/frontend-component-header-mitol@latest --legacy-peer-deps
          NODE_ENV=production npm run build
  - put: mfe-app-bucket
    params:
      source: mfe-app-gradebook/dist
      destination:
      - command: sync
        dir: s3-remote:xpro-qa-edxapp-mfe/gradebook/
