---
resource_types:
  - name: rclone
    type: docker-image
    source:
      repository: sothr/concourse-rclone-resource
      tag: latest
resources:
  - name: ol-infrastructure
    type: git
    source:
      uri: https://github.com/mitodl/ol-infrastructure.git
      branch: ((ol-infrastructure-git-ref))
  - name: ocw-www
    type: git
    source:
      uri: https://github.com/mitodl/ocw-www.git
      branch: ((ocw-www-git-ref))
  - name: ocw-hugo-themes
    type: git
    source:
      uri: https://github.com/mitodl/ocw-hugo-themes.git
      branch: ((ocw-hugo-theme-git-ref))
  - name: ocw-site
    type: rclone
    source:
      config: |
        [s3-remote]
        type = s3
        provider = AWS
        env_auth = true
        region = us-east-1

jobs:
  - name: build
    serial: true
    plan:
      - get: ol-infrastructure
      - get: ocw-www
      - get: ocw-hugo-themes
      - task: copy-go-mod-file
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: busybox}
          inputs:
            - name: ol-infrastructure
            - name: ocw-hugo-themes
            - name: ocw-www
          outputs:
            - name: ocw-www
            - name: ocw-hugo-themes
          run:
            path: ol-infrastructure/pipelines/ocw/scripts/modify-go-mod.sh
      - task: build-ocw-www-hugo-themes
        config:
          platform: linux
          image_resource:
            type:  docker-image
            source: {repository: mitodl/ocw-course-publisher, tag: "latest"}
          inputs:
            - name: ol-infrastructure
            - name: ocw-hugo-themes
            - name: ocw-www
          outputs:
            - name: ocw-www
          run:
            path: ol-infrastructure/pipelines/ocw/scripts/build-hugo-themes.sh
      - put: ocw-site
        params:
          source: ocw-www/dist/
          destination:
            - dir: s3-remote:((ocw-site-bucket))
            - args:
              - "--dry-run"
