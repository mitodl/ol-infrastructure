---
resource_types:
  - name: rclone
    type: docker-image
    source:
      repository: mitodl/concourse-rclone-resource
      tag: latest
resources:
  - name: ol-infrastructure
    type: git
    source:
      uri: https://github.com/mitodl/ol-infrastructure.git
      branch: ((ol-infrastructure-git-ref))
  - name: ocw-hugo-themes
    type: git
    source:
      uri: https://github.com/mitodl/ocw-hugo-themes.git
      branch: ((ocw-hugo-theme-git-ref))
  - name: ocw-artifacts
    type: rclone
    source:
      config: |
        [s3-remote]
        type = s3
        provider = AWS
        env_auth = true
        region = us-east-1

jobs:
  - name: build-theme-assets
    serial: true
    plan:
      - get: ol-infrastructure
      - get: ocw-hugo-themes
        trigger: true
      - task: build-ocw-www-hugo-theme
        config:
          platform: linux
          image_resource:
            type: docker-image
            source: {repository: mitodl/ocw-course-publisher, tag: latest}
          inputs:
            - name: ol-infrastructure
            - name: ocw-hugo-themes
          outputs:
            - name: ocw-hugo-themes
          run:
            path: sh
            args:
            - -exc
            - |
              cd ocw-hugo-themes
              yarn install --pure-lockfile
              npm run build:webpack
              mkdir -p dist/ocw-hugo-themes
              tar -cvzf dist/ocw-hugo-themes/ocw-hugo-themes-$(date +%s).tgz base-theme www course
      - put: ocw-artifacts
        params:
          source: ocw-hugo-themes/dist/
          destination:
            - dir: s3-remote:((artifact-bucket))
              command: sync
              args:
                - --ignore-size
                - --checksum
