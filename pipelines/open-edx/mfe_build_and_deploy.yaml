---
resource_types:
- name: rclone
  type: docker-image
  source:
    repository: mitodl/concourse-rclone-resource
    tag: latest

resources:
- name: mfe-app-(( vars.mfe_path ))
  type: git
  source:
    uri: (( vars.mfe_repository ))
    branch: (( vars.release_name ))
- name: mfe-app-bucket
  type: rclone
  source:
    config: |
      [s3-remote]
      type = s3
      provider = AWS
      env_auth = true
      region = us-east-1

jobs:
- name: build
  plan:
  - get: mfe-app-(( vars.mfe_path ))
    trigger: true
  - task: npm-install-and-build
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: node
          tag: (( vars.mfe_node_version ))-bullseye-slim
      inputs:
      - name: mfe-app-(( vars.mfe_path ))
      outputs:
      - name: mfe-app-(( vars.mfe_path ))/dist
      params:
        ACCESS_TOKEN_COOKIE_NAME: (( vars.environment ))-edx-jwt-cookie-header-payload
        BASE_URL: https://(( vars.lms_domain ))
        CSRF_TOKEN_API_PATH: /csrf/api/v1/token
        FAVICON_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/favicon.ico
        LMS_BASE_URL: https://(( vars.open_edx_lms_domain ))
        LOGIN_URL: https://(( vars.open_edx_lms_domain ))/login
        LOGOUT_URL: https://(( vars.open_edx_lms_domain ))/logout
        LOGO_TRADEMARK_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        LOGO_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        LOGO_WHITE_URL: https://raw.githubusercontent.com/mitodl/mitxpro-theme/master/lms/static/images/logo.png
        MARKETING_SITE_BASE_URL: https://(( vars.marketing_site_domain ))
        ORDER_HISTORY_URL:
        PUBLIC_PATH: /(( vars.mfe_path ))/
        REFRESH_ACCESS_TOKEN_ENDPOINT: https://(( vars.open_edx_lms_domain ))/login_refresh
        SEARCH_CATALOG_URL: https://(( vars.open_edx_lms_domain ))/courses
        SESSION_COOKIE_DOMAIN: (( vars.open_edx_lms_domain ))
        SITE_NAME: (( vars.site_name ))
        STUDIO_BASE_URL: https://(( vars.open_edx_studio_domain ))
        SUPPORT_URL: https://(( vars.support_url ))
        USER_INFO_COOKIE_NAME: (( vars.environment ))-edx-user-info
      run:
        path: sh
        dir: mfe-app-(( vars.mfe_path ))
        args:
        - -exc
        - |
          apt-get update
          apt-get install -q -y python build-essential
          npm install
          npm install @edx/frontend-component-footer@npm:@mitodl/frontend-component-footer-mitol@latest --legacy-peer-deps
          npm install @edx/frontend-component-header@npm:@mitodl/frontend-component-header-mitol@latest --legacy-peer-deps
          NODE_ENV=production npm run build
  - put: mfe-app-bucket
    params:
      source: mfe-app-(( vars.mfe_path ))/dist
      destination:
      - command: sync
        dir: s3-remote:(( vars.environment ))-edxapp-mfe/(( vars.mfe_path ))/
