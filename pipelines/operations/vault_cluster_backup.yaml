---
resource_types:
- name: s3-sync
  source:
    repository: mitodl/concourse-s3-sync-resource
  type: docker-image

resources:
- name: vault-snapshot-upload
  source:
    bucket: ((vault-snapshot-bucket))
  type: s3-sync
- name: hourly-trigger
  type: time
  source: {interval: 60m}

jobs:
- name: backup_vault_cluster
  plan:
  - get: hourly-trigger
    trigger: true
  - task: snapshot_vault_cluster
    config:
      image_resource:
        source:
          repository: vault
          tag: latest
        type: registry-image
      outputs:
      - name: snapshot
      platform: linux
      run:
        params:
          VAULT_AGENT_ADDR: http://localhost:8200
        path: sh
        args:
        - -exc
        - |
          cat <<EOF > /etc/vault.json
          {
            "vault": {
              "address": "((vault-cluster-address))",
              "tls_skip_verify": false
            },
            "auto_auth": {
              "method": {
                "type": "aws",
                "mount_path": "auth/aws",
                "config": {
                  "type": "iam",
                  "role": "((vault-role))",
                  "region": "us-east-1"
                }
              },
              "sink": [
                {
                  "type": "file",
                  "derive_key": false,
                  "config": [
                    {
                      "path": "/tmp/vault_agent_token"
                    }
                  ]
                }
              ]
            },
            "cache": {
              "use_auto_auth_token": "force"
            },
            "exit_after_auth": false,
            "listener": [
              {
                "tcp": {
                  "address": "127.0.0.1:8200",
                  "tls_disable": true
                }
              }
            ]
          }
          EOF
          vault agent -config /etc/vault.json &
          until [ -f /tmp/vault_agent_token ]; do sleep 1; done
          vault operator raft snapshot save -agent-address=http://localhost:8200 ../snapshot/$(date -Is).snap
          pkill -INT vault
  - put: vault-snapshot-upload
    inputs:
    - snapshot
