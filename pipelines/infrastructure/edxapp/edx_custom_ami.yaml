---
resource_types:
- name: packer
  source:
    repository: mitodl/concourse-packer-resource
    tag: latest
  type: docker-image
- name: packer-builder
  source:
    repository: mitodl/concourse-packer-resource-builder
    tag: latest
  type: docker-image
- name: ami
  type: docker-image
  source:
    repository: jdub/ami-resource
- name: pulumi
  source:
    repository: mitodl/concourse-pulumi-resource-provisioner
  type: docker-image

resources:
- name: edxapp-worker-base-ami
  type: ami
  check_every: 30m
  source:
    region: us-east-1
    filters:
      owner-id: 610119931565
      is-public: false
      state: available
      name: edxapp-worker-((edx_release))-*
- name: edxapp-web-base-ami
  type: ami
  check_every: 30m
  source:
    region: us-east-1
    filters:
      owner-id: 610119931565
      is-public: false
      state: available
      name: edxapp-web-((edx_release))-*
- icon: github
  name: packer_templates
  source:
    branch: main
    paths:
    - src/bilder/images/edxapp/
    uri: https://github.com/mitodl/ol-infrastructure
  type: git
- name: packer-validate
  type: packer
- name: packer-build
  type: packer-builder

jobs:
- name: validate-custom-packer-template
  plan:
  - get: edxapp-worker-base-ami
    trigger: true
  - get: edxapp-web-base-ami
    trigger: true
  - get: packer_templates
    trigger: true
  - in_parallel:
    - put: packer-validate
      params:
        objective: validate
        only:
        - amazon-ebs.edxapp
        template: packer_templates/src/bilder/images/edxapp/custom_install.pkr.hcl
        var_files:
        - packer_templates/src/bilder/images/edxapp/packer_vars/((edx_installation)).pkrvars.hcl
        vars:
          node_type: web
    - put: packer-validate
      params:
        objective: validate
        only:
        - amazon-ebs.edxapp
        template: packer_templates/src/bilder/images/edxapp/custom_install.pkr.hcl
        var_files:
        - packer_templates/src/bilder/images/edxapp/packer_vars/((edx_installation)).pkrvars.hcl
        vars:
          node_type: worker

- name: build-custom-packer-template
  plan:
  - get: edxapp-worker-base-ami
    trigger: true
    passed:
    - validate-custom-packer-template
  - get: edxapp-web-base-ami
    trigger: true
    passed:
    - validate-custom-packer-template
  - get: packer_templates
    trigger: true
  - in_parallel:
    - put: packer-build
      params:
        env_vars:
          AWS_REGION: us-east-1
          PYTHONPATH: ${PYTHONPATH}:packer_templates/src
        objective: build
        only:
        - amazon-ebs.edxapp
        template: packer_templates/src/bilder/images/edxapp/custom_install.pkr.hcl
        var_files:
        - packer_templates/src/bilder/images/edxapp/packer_vars/((edx_installation)).pkrvars.hcl
        vars:
          node_type: web
    - put: packer-build
      params:
        env_vars:
          AWS_REGION: us-east-1
          PYTHONPATH: ${PYTHONPATH}:packer_templates/src
        objective: build
        only:
        - amazon-ebs.edxapp
        template: packer_templates/src/bilder/images/edxapp/custom_install.pkr.hcl
        var_files:
        - packer_templates/src/bilder/images/edxapp/packer_vars/((edx_installation)).pkrvars.hcl
        vars:
          node_type: worker
